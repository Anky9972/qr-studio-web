generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Announcement {
  id                  String    @id
  title               String
  message             String
  type                String    @default("info")
  active              Boolean   @default(true)
  targetAudience      String    @default("all")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  emailSent           Boolean   @default(false)
  emailSentAt         DateTime?
  sendEmail           Boolean   @default(false)
  sendWebNotification Boolean   @default(true)

  @@index([active])
  @@index([targetAudience])
}

model ApiKey {
  id         String    @id
  userId     String
  name       String
  keyHash    String    @unique
  keyPrefix  String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  User       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

model AuditLog {
  id         String   @id
  userId     String
  action     String
  entityType String
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@index([userId])
}

model CTAFrame {
  id         String   @id
  name       String
  category   String
  svgContent String
  preview    String?
  variables  Json
  premium    Boolean  @default(false)
  useCount   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([category])
  @@index([premium])
}

model Campaign {
  id          String    @id
  userId      String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  endDate     DateTime?
  startDate   DateTime?
  tags        String[]  @default([])
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  QRCode      QRCode[]

  @@index([userId])
}

model ComplianceSettings {
  id                    String   @id
  userId                String   @unique
  gdprMode              Boolean  @default(false)
  dataRetentionDays     Int      @default(365)
  anonymizeScans        Boolean  @default(false)
  allowDataExport       Boolean  @default(true)
  allowDataDeletion     Boolean  @default(true)
  cookieConsentRequired Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  User                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CustomDomain {
  id                String    @id
  userId            String
  domain            String    @unique
  verified          Boolean   @default(false)
  sslEnabled        Boolean   @default(false)
  cnameTarget       String    @default("qrstudio.app")
  verificationToken String    @unique
  verifiedAt        DateTime?
  lastChecked       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([userId])
  @@index([verified])
}

model DigitalMenu {
  id          String   @id
  userId      String
  slug        String   @unique
  title       String
  description String?
  logo        String?
  coverImage  String?
  type        String   @default("menu")
  categories  Json
  theme       Json?
  settings    Json?
  viewCount   Int      @default(0)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  QRCode      QRCode[]

  @@index([published])
  @@index([slug])
  @@index([type])
  @@index([userId])
}

model LeadGate {
  id              String   @id
  userId          String
  name            String
  title           String
  description     String?
  fields          Json
  redirectUrl     String
  submitText      String   @default("Continue")
  theme           Json?
  submissions     Json[]   @default([])
  submissionCount Int      @default(0)
  published       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  QRCode          QRCode[]

  @@index([published])
  @@index([userId])
}

model LinkInBio {
  id           String   @id
  userId       String
  slug         String   @unique
  title        String
  description  String?
  profileImage String?
  theme        Json?
  links        Json
  socialLinks  Json?
  analytics    Boolean  @default(true)
  viewCount    Int      @default(0)
  published    Boolean  @default(true)
  customCss    String?
  seo          Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  QRCode       QRCode[]

  @@index([published])
  @@index([slug])
  @@index([userId])
}

model Microsite {
  id          String   @id
  userId      String
  slug        String   @unique
  title       String
  description String?
  type        String
  theme       Json?
  content     Json
  seo         Json?
  customCss   String?
  published   Boolean  @default(false)
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([published])
  @@index([slug])
  @@index([type])
  @@index([userId])
}

model NotificationLog {
  id      String   @id
  userId  String
  type    String
  subject String
  message String
  sentAt  DateTime @default(now())
  success Boolean
  error   String?

  @@index([sentAt])
  @@index([type])
  @@index([userId])
}

model NotificationSetting {
  id        String   @id
  userId    String
  type      String
  enabled   Boolean  @default(true)
  frequency String?
  threshold Int?
  qrCodeIds String[]
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([type])
  @@index([userId])
}

model Offer {
  id              String   @id
  title           String
  description     String
  discountPercent Int
  couponCode      String   @unique
  validFrom       DateTime
  validUntil      DateTime
  targetPlan      String   @default("all")
  active          Boolean  @default(true)
  usageCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime

  @@index([active])
  @@index([couponCode])
  @@index([validUntil])
}

model PixelConfig {
  id            String   @id
  qrCodeId      String
  provider      String
  pixelId       String
  events        String[]
  delayRedirect Int      @default(1000)
  active        Boolean  @default(true)
  scriptContent String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  QRCode        QRCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([provider])
  @@index([qrCodeId])
}

model QRCode {
  id            String        @id
  userId        String
  name          String?
  type          String
  content       String
  qrType        String
  size          Int           @default(512)
  foreground    String        @default("#000000")
  background    String        @default("#FFFFFF")
  logo          String?
  errorLevel    String        @default("M")
  pattern       String        @default("square")
  design        Json?
  shortUrl      String?       @unique
  destination   String?
  password      String?
  expiresAt     DateTime?
  campaignId    String?
  tags          String[]
  favorite      Boolean       @default(false)
  scanCount     Int           @default(0)
  lastScanned   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  customDomain  String?
  frameId       String?
  maxScans      Int?
  micrositeId   String?
  utmParams     Json?
  digitalMenuId String?
  leadGateId    String?
  linkInBioId   String?
  vCardPlusId   String?
  PixelConfig   PixelConfig[]
  Campaign      Campaign?     @relation(fields: [campaignId], references: [id])
  DigitalMenu   DigitalMenu?  @relation(fields: [digitalMenuId], references: [id])
  LeadGate      LeadGate?     @relation(fields: [leadGateId], references: [id])
  LinkInBio     LinkInBio?    @relation(fields: [linkInBioId], references: [id])
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  VCardPlus     VCardPlus?    @relation(fields: [vCardPlusId], references: [id])
  RoutingRule   RoutingRule[]
  Scan          Scan[]

  @@index([campaignId])
  @@index([customDomain])
  @@index([shortUrl])
  @@index([userId])
}

model RoutingRule {
  id          String   @id
  qrCodeId    String
  type        String
  condition   Json
  destination String
  priority    Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  QRCode      QRCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([qrCodeId])
  @@index([type])
}

model Scan {
  id        String   @id
  qrCodeId  String
  ipAddress String?
  userAgent String?
  country   String?
  city      String?
  device    String?
  browser   String?
  os        String?
  referrer  String?
  scannedAt DateTime @default(now())
  isUnique  Boolean  @default(true)
  visitorId String?
  QRCode    QRCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([isUnique])
  @@index([qrCodeId])
  @@index([scannedAt])
  @@index([visitorId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Team {
  id         String       @id
  name       String
  plan       String       @default("business")
  createdAt  DateTime     @default(now())
  updatedAt  DateTime
  TeamMember TeamMember[]
}

model TeamMember {
  id       String   @id
  teamId   String
  userId   String
  role     String   @default("viewer")
  joinedAt DateTime @default(now())
  Team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Template {
  id          String   @id
  userId      String
  name        String
  description String?
  category    String
  public      Boolean  @default(false)
  design      Json
  preview     String?
  useCount    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([userId])
}

model User {
  id                  String                @id
  name                String?
  email               String?               @unique
  emailVerified       DateTime?
  image               String?
  password            String?
  role                String                @default("user")
  plan                String                @default("free")
  planExpiry          DateTime?
  isAdmin             Boolean               @default(false)
  subscription        String                @default("FREE")
  lastLoginAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  emailNotifications  Boolean               @default(true)
  expirationReminders Boolean               @default(true)
  limitWarnings       Boolean               @default(true)
  scanAlerts          Boolean               @default(false)
  weeklyReports       Boolean               @default(true)
  Account             Account[]
  ApiKey              ApiKey[]
  AuditLog            AuditLog[]
  Campaign            Campaign[]
  ComplianceSettings  ComplianceSettings?
  CustomDomain        CustomDomain[]
  DigitalMenu         DigitalMenu[]
  LeadGate            LeadGate[]
  LinkInBio           LinkInBio[]
  Microsite           Microsite[]
  NotificationSetting NotificationSetting[]
  QRCode              QRCode[]
  Session             Session[]
  TeamMember          TeamMember[]
  Template            Template[]
  VCardPlus           VCardPlus[]
  Webhook             Webhook[]

  @@index([lastLoginAt])
}

model VCardPlus {
  id              String   @id
  userId          String
  slug            String   @unique
  firstName       String
  lastName        String
  company         String?
  jobTitle        String?
  email           String?
  phone           String?
  website         String?
  address         String?
  profilePhoto    String?
  coverPhoto      String?
  bio             String?
  socialLinks     Json?
  customFields    Json?
  theme           Json?
  downloadEnabled Boolean  @default(true)
  viewCount       Int      @default(0)
  published       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  QRCode          QRCode[]
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([published])
  @@index([slug])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Webhook {
  id           String       @id
  userId       String
  url          String
  events       String[]
  secret       String
  active       Boolean      @default(true)
  lastUsedAt   DateTime?
  failureCount Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  WebhookLog   WebhookLog[]

  @@index([active])
  @@index([userId])
}

model WebhookLog {
  id         String   @id
  webhookId  String
  event      String
  payload    Json
  response   Json?
  statusCode Int?
  success    Boolean
  attempt    Int      @default(1)
  error      String?
  createdAt  DateTime @default(now())
  Webhook    Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([event])
  @@index([webhookId])
}
